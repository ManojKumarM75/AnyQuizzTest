<!DOCTYPE html>
<html>
<head>
    <title>Google Sign-In Example</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* ... (keep the existing styles) ... */
    </style>
</head>
<body>
    <div id="header">
        <div id="user-info"></div>
        <button id="login-button" onclick="handleSignIn()">Sign In</button>
        <button id="logout-button" onclick="handleSignOut()">Sign Out</button>
    </div>
    <div id="message"></div>

    <script>
    let tokenClient;

    function handleCredentialResponse(response) {
        console.log("Credential Response:", response);
        if (response.credential) {
            console.log("Encoded JWT ID token: " + response.credential);
            sendTokenToAppsScript(response.credential, 'login');
            updateUIAfterSignIn(response.credential);
        } else {
            console.error("No credential received in the response");
            document.getElementById('message').textContent = "Error: No credential received";
        }
    }

    function sendTokenToAppsScript(token, action) {
        var script = document.createElement('script');
        script.src = `https://script.google.com/macros/s/AKfycbyvTJAQE71K__SiZqaYMaocJL433rH9JcbEohgpXZ9a76nK61WbalvccVr4NwJixfy4/exec?callback=handleResponse&token=${encodeURIComponent(token)}&action=${action}`;
        document.body.appendChild(script);
    }

    function handleResponse(data) {
        console.log('Response from Apps Script:', data);
        if (data.error) {
            document.getElementById('message').textContent = "Error: " + data.error;
        } else {
            document.getElementById('message').textContent = data.message;
        }
    }

    function updateUIAfterSignIn(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            document.getElementById('user-info').textContent = payload.name;
            document.getElementById('user-info').style.display = 'block';
            document.getElementById('login-button').style.display = 'none';
            document.getElementById('logout-button').style.display = 'inline-block';
        } catch (error) {
            console.error("Error parsing token:", error);
            document.getElementById('message').textContent = "Error parsing user info";
        }
    }

    function handleSignIn() {
        tokenClient.requestAccessToken({prompt: 'consent'});
    }

    function handleSignOut() {
        google.accounts.id.disableAutoSelect();
        google.accounts.oauth2.revoke(localStorage.getItem('access_token'), () => {
            console.log('Token revoked');
            localStorage.removeItem('access_token');
        });
        sendTokenToAppsScript('', 'logout');
        document.getElementById('user-info').style.display = 'none';
        document.getElementById('login-button').style.display = 'inline-block';
        document.getElementById('logout-button').style.display = 'none';
        document.getElementById('message').textContent = '';
    }

    window.onload = function () {
        google.accounts.id.initialize({
            client_id: '44063799736-jl9n0up9qa94t8imacu9r0g4djf81ej1.apps.googleusercontent.com',
            callback: handleCredentialResponse,
            auto_select: false
        });

        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: '44063799736-jl9n0up9qa94t8imacu9r0g4djf81ej1.apps.googleusercontent.com',
            scope: 'email profile',
            callback: (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) {
                    localStorage.setItem('access_token', tokenResponse.access_token);
                    fetch(`https://www.googleapis.com/oauth2/v3/userinfo?access_token=${tokenResponse.access_token}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log("User Info:", data);
                            handleCredentialResponse({credential: tokenResponse.access_token});
                        })
                        .catch(error => {
                            console.error("Error fetching user info:", error);
                            document.getElementById('message').textContent = "Error fetching user info";
                        });
                } else {
                    console.error("No access token received");
                    document.getElementById('message').textContent = "Error: No access token received";
                }
            }
        });
    };
    </script>
</body>
</html>
